<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Webcam GIF Capture</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: #1a1a2e;
      color: #eee;
      min-height: 100vh;
      padding: 20px;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    
    header {
      text-align: center;
      margin-bottom: 30px;
    }
    
    header h1 {
      color: #00d4ff;
      font-size: 2rem;
      margin-bottom: 5px;
    }
    
    header p {
      color: #888;
    }
    
    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }
    
    @media (max-width: 900px) {
      .grid {
        grid-template-columns: 1fr;
      }
    }
    
    .card {
      background: #16213e;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }
    
    .card h2 {
      color: #00d4ff;
      font-size: 1.2rem;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid #2a2a4a;
    }
    
    .status-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
    }
    
    .status-item {
      background: #1a1a2e;
      padding: 12px;
      border-radius: 8px;
    }
    
    .status-item label {
      color: #888;
      font-size: 0.8rem;
      display: block;
      margin-bottom: 4px;
    }
    
    .status-item .value {
      font-size: 1.1rem;
      font-weight: 600;
    }
    
    .status-item .value.capturing {
      color: #4caf50;
    }
    
    .status-item .value.waiting {
      color: #ff9800;
    }
    
    .status-item .value.idle {
      color: #888;
    }
    
    .status-item .value.generating {
      color: #9c27b0;
    }
    
    .form-group {
      margin-bottom: 15px;
    }
    
    .form-group label {
      display: block;
      color: #888;
      font-size: 0.9rem;
      margin-bottom: 6px;
    }
    
    .form-group input,
    .form-group select {
      width: 100%;
      padding: 10px 12px;
      background: #1a1a2e;
      border: 1px solid #2a2a4a;
      border-radius: 6px;
      color: #eee;
      font-size: 1rem;
    }
    
    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: #00d4ff;
    }
    
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }
    
    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .checkbox-group input[type="checkbox"] {
      width: 20px;
      height: 20px;
      cursor: pointer;
    }
    
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 6px;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.2s;
      font-weight: 500;
    }
    
    .btn-primary {
      background: #00d4ff;
      color: #1a1a2e;
    }
    
    .btn-primary:hover {
      background: #00b8e6;
    }
    
    .btn-success {
      background: #4caf50;
      color: white;
    }
    
    .btn-success:hover {
      background: #43a047;
    }
    
    .btn-danger {
      background: #f44336;
      color: white;
    }
    
    .btn-danger:hover {
      background: #e53935;
    }
    
    .btn-secondary {
      background: #2a2a4a;
      color: #eee;
    }
    
    .btn-secondary:hover {
      background: #3a3a5a;
    }
    
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .btn-group {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }
    
    .preview-container {
      text-align: center;
    }
    
    .preview-image {
      max-width: 100%;
      border-radius: 8px;
      margin-top: 15px;
      display: none;
    }
    
    .preview-placeholder {
      background: #1a1a2e;
      border-radius: 8px;
      padding: 40px;
      color: #888;
    }
    
    .gif-gallery {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }
    
    .gif-item {
      background: #1a1a2e;
      border-radius: 8px;
      overflow: hidden;
      cursor: pointer;
      transition: transform 0.2s;
    }
    
    .gif-item:hover {
      transform: scale(1.02);
    }
    
    .gif-item img {
      width: 100%;
      display: block;
    }
    
    .gif-item .info {
      padding: 10px;
    }
    
    .gif-item .info .date {
      font-weight: 600;
    }
    
    .gif-item .info .meta {
      color: #888;
      font-size: 0.85rem;
      margin-top: 4px;
    }
    
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    
    .modal.active {
      display: flex;
    }
    
    .modal-content {
      max-width: 90%;
      max-height: 90%;
    }
    
    .modal-content img {
      max-width: 100%;
      max-height: 90vh;
      border-radius: 8px;
    }
    
    .modal-close {
      position: absolute;
      top: 20px;
      right: 30px;
      font-size: 2rem;
      color: white;
      cursor: pointer;
    }
    
    .alert {
      padding: 12px 16px;
      border-radius: 6px;
      margin-bottom: 15px;
    }
    
    .alert-success {
      background: rgba(76, 175, 80, 0.2);
      border: 1px solid #4caf50;
      color: #4caf50;
    }
    
    .alert-error {
      background: rgba(244, 67, 54, 0.2);
      border: 1px solid #f44336;
      color: #f44336;
    }
    
    .empty-state {
      text-align: center;
      padding: 40px;
      color: #888;
    }
    
    .full-width {
      grid-column: 1 / -1;
    }
    
    .countdown {
      font-family: monospace;
      font-size: 1.5rem;
      color: #00d4ff;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>üé• Webcam GIF Capture</h1>
      <p>Automated sunrise/sunset timelapse generator</p>
    </header>
    
    <div id="alert-container"></div>
    
    <div class="grid">
      <!-- Status Card -->
      <div class="card">
        <h2>üìä Status</h2>
        <div class="status-grid">
          <div class="status-item">
            <label>Current Status</label>
            <div class="value" id="status-state">Loading...</div>
          </div>
          <div class="status-item">
            <label>Captures Today</label>
            <div class="value" id="status-captures">0</div>
          </div>
          <div class="status-item">
            <label>Event Type</label>
            <div class="value" id="status-event">-</div>
          </div>
          <div class="status-item">
            <label>Next Capture</label>
            <div class="value" id="status-next">-</div>
          </div>
        </div>
        <div style="margin-top: 15px; text-align: center;">
          <label style="color: #888; font-size: 0.9rem;">Time until next event</label>
          <div class="countdown" id="countdown">--:--:--</div>
        </div>
        <div class="btn-group">
          <button class="btn btn-success" id="btn-start" onclick="startCapture()">‚ñ∂ Start Capture</button>
          <button class="btn btn-danger" id="btn-stop" onclick="stopCapture()" disabled>‚èπ Stop Capture</button>
        </div>
        
        <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #2a2a4a;">
          <h3 style="font-size: 1rem; color: #888; margin-bottom: 10px;">Manual Capture Settings</h3>
          <div class="form-row">
            <div class="form-group" style="margin-bottom: 0;">
              <label>Interval (seconds)</label>
              <input type="number" id="manual-interval" min="1" max="300" value="15">
            </div>
            <div class="form-group" style="margin-bottom: 0;">
              <label>Number of pictures (0 = unlimited)</label>
              <input type="number" id="manual-max-captures" min="0" max="1000" value="0">
            </div>
          </div>
        </div>
      </div>
      
      <!-- Camera Preview Card -->
      <div class="card">
        <h2>üì∑ Camera Preview</h2>
        <div class="preview-container">
          <div class="preview-placeholder" id="preview-placeholder">
            Click "Test Camera" to see a live preview
          </div>
          <img id="preview-image" class="preview-image" alt="Camera preview">
        </div>
        <div class="btn-group">
          <button class="btn btn-primary" onclick="testCamera()">üîÑ Test Camera</button>
        </div>
      </div>
      
      <!-- Configuration Card -->
      <div class="card">
        <h2>‚öôÔ∏è Configuration</h2>
        <form id="config-form" onsubmit="saveConfig(event)">
          <div class="form-group">
            <label>Camera URL</label>
            <input type="text" id="config-camera-url" placeholder="http://192.168.1.72/capture">
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label>Event Type</label>
              <select id="config-event-type">
                <option value="sunrise">Sunrise</option>
                <option value="sunset">Sunset</option>
              </select>
            </div>
            <div class="form-group">
              <label>Capture Interval (seconds)</label>
              <input type="number" id="config-interval" min="5" max="300" value="15">
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label>Offset (minutes before/after)</label>
              <input type="number" id="config-offset" min="5" max="120" value="30">
            </div>
            <div class="form-group">
              <label>GIF Frame Delay (ms)</label>
              <input type="number" id="config-frame-delay" min="50" max="500" value="100">
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label>GIF Width (px)</label>
              <input type="number" id="config-gif-width" min="320" max="1920" value="800">
            </div>
            <div class="form-group checkbox-group" style="align-self: end; padding-bottom: 10px;">
              <input type="checkbox" id="config-enabled" checked>
              <label for="config-enabled" style="margin: 0;">Scheduled Capture Enabled</label>
            </div>
          </div>
          
          <div class="btn-group">
            <button type="submit" class="btn btn-primary">üíæ Save Configuration</button>
          </div>
        </form>
      </div>
      
      <!-- Sun Times Card -->
      <div class="card">
        <h2>üåÖ Sun Times (Valencia)</h2>
        <div class="status-grid">
          <div class="status-item">
            <label>Sunrise</label>
            <div class="value" id="sun-sunrise">-</div>
          </div>
          <div class="status-item">
            <label>Sunset</label>
            <div class="value" id="sun-sunset">-</div>
          </div>
          <div class="status-item">
            <label>Solar Noon</label>
            <div class="value" id="sun-noon">-</div>
          </div>
          <div class="status-item">
            <label>Day Length</label>
            <div class="value" id="sun-length">-</div>
          </div>
        </div>
        <div class="btn-group">
          <button class="btn btn-secondary" onclick="refreshSunTimes()">üîÑ Refresh Sun Times</button>
        </div>
      </div>
      
      <!-- GIF Gallery Card -->
      <div class="card full-width">
        <h2>üé¨ GIF Gallery</h2>
        <div class="gif-gallery" id="gif-gallery">
          <div class="empty-state">No GIFs generated yet</div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Modal for viewing GIFs -->
  <div class="modal" id="gif-modal" onclick="closeModal()">
    <span class="modal-close">&times;</span>
    <div class="modal-content">
      <img id="modal-image" src="" alt="GIF">
    </div>
  </div>
  
  <script>
    // State
    let currentConfig = null;
    let statusInterval = null;
    let countdownInterval = null;
    let nextEventTime = null;
    
    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      loadConfig();
      loadStatus();
      loadGifs();
      loadSunTimes();
      
      // Refresh status every 5 seconds
      statusInterval = setInterval(loadStatus, 5000);
      
      // Update countdown every second
      countdownInterval = setInterval(updateCountdown, 1000);
    });
    
    // Show alert
    function showAlert(message, type = 'success') {
      const container = document.getElementById('alert-container');
      const alert = document.createElement('div');
      alert.className = `alert alert-${type}`;
      alert.textContent = message;
      container.appendChild(alert);
      
      setTimeout(() => alert.remove(), 5000);
    }
    
    // Load configuration
    async function loadConfig() {
      try {
        const response = await fetch('/api/config');
        currentConfig = await response.json();
        
        document.getElementById('config-camera-url').value = currentConfig.camera.url;
        document.getElementById('config-event-type').value = currentConfig.capture.eventType;
        document.getElementById('config-interval').value = currentConfig.capture.intervalSeconds;
        document.getElementById('config-offset').value = currentConfig.capture.offsetMinutes;
        document.getElementById('config-frame-delay').value = currentConfig.gif.frameDelayMs;
        document.getElementById('config-gif-width').value = currentConfig.gif.resizeWidth;
        document.getElementById('config-enabled').checked = currentConfig.capture.enabled;
      } catch (error) {
        showAlert('Failed to load configuration', 'error');
      }
    }
    
    // Save configuration
    async function saveConfig(event) {
      event.preventDefault();
      
      const config = {
        camera: {
          url: document.getElementById('config-camera-url').value
        },
        capture: {
          eventType: document.getElementById('config-event-type').value,
          intervalSeconds: parseInt(document.getElementById('config-interval').value),
          offsetMinutes: parseInt(document.getElementById('config-offset').value),
          enabled: document.getElementById('config-enabled').checked
        },
        gif: {
          frameDelayMs: parseInt(document.getElementById('config-frame-delay').value),
          resizeWidth: parseInt(document.getElementById('config-gif-width').value)
        }
      };
      
      try {
        const response = await fetch('/api/config', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(config)
        });
        
        if (response.ok) {
          showAlert('Configuration saved successfully');
          loadStatus();
        } else {
          throw new Error('Failed to save');
        }
      } catch (error) {
        showAlert('Failed to save configuration', 'error');
      }
    }
    
    // Load status
    async function loadStatus() {
      try {
        const response = await fetch('/api/status');
        const data = await response.json();
        
        const stateEl = document.getElementById('status-state');
        stateEl.textContent = data.state.status.charAt(0).toUpperCase() + data.state.status.slice(1);
        stateEl.className = `value ${data.state.status}`;
        
        document.getElementById('status-captures').textContent = data.state.captureCount || 0;
        document.getElementById('status-event').textContent = data.settings.eventType.charAt(0).toUpperCase() + data.settings.eventType.slice(1);
        
        if (data.state.nextCaptureWindow) {
          const startTime = new Date(data.state.nextCaptureWindow.start);
          nextEventTime = startTime;
          document.getElementById('status-next').textContent = startTime.toLocaleTimeString();
        } else {
          nextEventTime = null;
          document.getElementById('status-next').textContent = '-';
        }
        
        // Update button states
        const isCapturing = data.state.status === 'capturing';
        document.getElementById('btn-start').disabled = isCapturing;
        document.getElementById('btn-stop').disabled = !isCapturing;
        
      } catch (error) {
        console.error('Failed to load status:', error);
      }
    }
    
    // Update countdown
    function updateCountdown() {
      const el = document.getElementById('countdown');
      
      if (!nextEventTime) {
        el.textContent = '--:--:--';
        return;
      }
      
      const now = new Date();
      const diff = nextEventTime - now;
      
      if (diff <= 0) {
        el.textContent = 'Starting...';
        return;
      }
      
      const hours = Math.floor(diff / (1000 * 60 * 60));
      const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
      const seconds = Math.floor((diff % (1000 * 60)) / 1000);
      
      el.textContent = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }
    
    // Load sun times
    async function loadSunTimes() {
      try {
        const response = await fetch('/api/sun-times');
        const data = await response.json();
        
        document.getElementById('sun-sunrise').textContent = new Date(data.sunrise).toLocaleTimeString();
        document.getElementById('sun-sunset').textContent = new Date(data.sunset).toLocaleTimeString();
        document.getElementById('sun-noon').textContent = new Date(data.solarNoon).toLocaleTimeString();
        
        // Format day length (seconds to hours:minutes)
        const hours = Math.floor(data.dayLength / 3600);
        const minutes = Math.floor((data.dayLength % 3600) / 60);
        document.getElementById('sun-length').textContent = `${hours}h ${minutes}m`;
        
      } catch (error) {
        console.error('Failed to load sun times:', error);
      }
    }
    
    // Refresh sun times
    async function refreshSunTimes() {
      try {
        await fetch('/api/sun-times/refresh', { method: 'POST' });
        await loadSunTimes();
        showAlert('Sun times refreshed');
      } catch (error) {
        showAlert('Failed to refresh sun times', 'error');
      }
    }
    
    // Test camera
    async function testCamera() {
      const placeholder = document.getElementById('preview-placeholder');
      const image = document.getElementById('preview-image');
      
      placeholder.textContent = 'Loading...';
      
      try {
        const response = await fetch('/api/camera/test');
        const data = await response.json();
        
        if (data.success) {
          // Load actual preview
          image.src = '/api/preview?' + Date.now();
          image.style.display = 'block';
          placeholder.style.display = 'none';
          showAlert(`Camera OK - ${Math.round(data.size / 1024)} KB`);
        } else {
          throw new Error(data.error);
        }
      } catch (error) {
        placeholder.textContent = 'Failed to connect to camera: ' + error.message;
        placeholder.style.display = 'block';
        image.style.display = 'none';
        showAlert('Camera connection failed', 'error');
      }
    }
    
    // Start capture
    async function startCapture() {
      const intervalSeconds = parseInt(document.getElementById('manual-interval').value) || 15;
      const maxCaptures = parseInt(document.getElementById('manual-max-captures').value) || 0;
      
      try {
        const response = await fetch('/api/capture/start', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            intervalSeconds,
            maxCaptures: maxCaptures > 0 ? maxCaptures : null
          })
        });
        const data = await response.json();
        
        if (data.success) {
          showAlert(data.message);
          loadStatus();
          
          // If capture completed immediately (fixed number reached)
          if (data.message.includes('completed')) {
            loadGifs();
          }
        } else {
          showAlert(data.message, 'error');
        }
      } catch (error) {
        showAlert('Failed to start capture', 'error');
      }
    }
    
    // Stop capture
    async function stopCapture() {
      try {
        const response = await fetch('/api/capture/stop', { method: 'POST' });
        const data = await response.json();
        
        if (data.success) {
          showAlert('Capture stopped - GIF generated');
          loadStatus();
          loadGifs();
        } else {
          showAlert(data.message, 'error');
        }
      } catch (error) {
        showAlert('Failed to stop capture', 'error');
      }
    }
    
    // Load GIFs
    async function loadGifs() {
      try {
        const response = await fetch('/api/gifs');
        const gifs = await response.json();
        
        const gallery = document.getElementById('gif-gallery');
        
        if (gifs.length === 0) {
          gallery.innerHTML = '<div class="empty-state">No GIFs generated yet</div>';
          return;
        }
        
        gallery.innerHTML = gifs.map(gif => `
          <div class="gif-item" onclick="openModal('${gif.path}')">
            <img src="${gif.path}" alt="${gif.filename}" loading="lazy">
            <div class="info">
              <div class="date">${gif.date} - ${gif.eventType}</div>
              <div class="meta">${gif.sizeFormatted}</div>
            </div>
          </div>
        `).join('');
        
      } catch (error) {
        console.error('Failed to load GIFs:', error);
      }
    }
    
    // Modal functions
    function openModal(src) {
      const modal = document.getElementById('gif-modal');
      const image = document.getElementById('modal-image');
      image.src = src;
      modal.classList.add('active');
    }
    
    function closeModal() {
      const modal = document.getElementById('gif-modal');
      modal.classList.remove('active');
    }
    
    // Close modal on escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') closeModal();
    });
  </script>
</body>
</html>
