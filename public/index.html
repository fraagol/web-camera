<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Webcam GIF Capture</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="container">
    <header>
      <h1>üé• Webcam GIF Capture</h1>
      <p>Automated sunrise/sunset timelapse generator</p>
    </header>
    
    <div id="alert-container"></div>
    
    <div class="tabs">
      <button class="tab-btn active" onclick="switchTab('dashboard')">üìä Dashboard</button>
      <button class="tab-btn" onclick="switchTab('captures')">üì∏ Captures</button>
    </div>

    <div id="tab-dashboard" class="tab-content active">
    <div class="grid">
      <!-- Status Card -->
      <div class="card">
        <h2>üìä Status</h2>
        <div class="status-grid">
          <div class="status-item">
            <label>Current Status</label>
            <div class="value" id="status-state">Loading...</div>
          </div>
          <div class="status-item">
            <label>Captures Today</label>
            <div class="value" id="status-captures">0</div>
          </div>
          <div class="status-item">
            <label>Event Type</label>
            <div class="value" id="status-event">-</div>
          </div>
          <div class="status-item">
            <label>Next Capture</label>
            <div class="value" id="status-next">-</div>
            <div style="color: #888; font-size: 0.8rem; margin-top: 4px;" id="status-next-date"></div>
          </div>
        </div>
        <div style="margin-top: 15px; text-align: center;">
          <label style="color: #888; font-size: 0.9rem;">Time until next event</label>
          <div class="countdown" id="countdown">--:--:--</div>
        </div>
        <div class="btn-group">
          <button class="btn btn-success" id="btn-start" onclick="startCapture()">‚ñ∂ Start Capture</button>
          <button class="btn btn-danger" id="btn-stop" onclick="stopCapture()" disabled>‚èπ Stop Capture</button>
        </div>
        
        <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #2a2a4a;">
          <h3 style="font-size: 1rem; color: #888; margin-bottom: 10px;">Manual Capture Settings</h3>
          <div class="form-row">
            <div class="form-group" style="margin-bottom: 0;">
              <label>Interval (seconds)</label>
              <input type="number" id="manual-interval" min="1" max="300" value="15">
            </div>
            <div class="form-group" style="margin-bottom: 0;">
              <label>Number of pictures (0 = unlimited)</label>
              <input type="number" id="manual-max-captures" min="0" max="1000" value="0">
            </div>
          </div>
        </div>
      </div>
      
      <!-- Camera Preview Card -->
      <div class="card">
        <h2>üì∑ Camera Preview</h2>
        <div class="preview-container">
          <div class="preview-placeholder" id="preview-placeholder">
            Click "Test Camera" to see a live preview
          </div>
          <img id="preview-image" class="preview-image" alt="Camera preview">
        </div>
        <div class="btn-group">
          <button class="btn btn-primary" onclick="testCamera()">üîÑ Test Camera</button>
        </div>
      </div>
      
      <!-- Configuration Card -->
      <div class="card">
        <h2>‚öôÔ∏è Configuration</h2>
        <form id="config-form" onsubmit="saveConfig(event)">
          <div class="form-group">
            <label>Camera URL</label>
            <input type="text" id="config-camera-url" placeholder="http://192.168.1.72/capture">
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label>Event Type</label>
              <select id="config-event-type">
                <option value="sunrise">Sunrise</option>
                <option value="sunset">Sunset</option>
              </select>
            </div>
            <div class="form-group">
              <label>Capture Interval (seconds)</label>
              <input type="number" id="config-interval" min="5" max="300" value="15">
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label>Offset (minutes before/after)</label>
              <input type="number" id="config-offset" min="5" max="120" value="30">
            </div>
            <div class="form-group">
              <label>GIF Frame Delay (ms)</label>
              <input type="number" id="config-frame-delay" min="50" max="500" value="100">
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label>GIF Width (px)</label>
              <input type="number" id="config-gif-width" min="320" max="1920" value="800">
            </div>
            <div class="form-group checkbox-group" style="align-self: end; padding-bottom: 10px;">
              <input type="checkbox" id="config-enabled" checked>
              <label for="config-enabled" style="margin: 0;">Scheduled Capture Enabled</label>
            </div>
          </div>
          
          <div class="btn-group">
            <button type="submit" class="btn btn-primary">üíæ Save Configuration</button>
          </div>
        </form>
      </div>
      
      <!-- Sun Times Card -->
      <div class="card">
        <h2>üåÖ Sun Times (Valencia)</h2>
        <div class="status-grid">
          <div class="status-item">
            <label>Sunrise</label>
            <div class="value" id="sun-sunrise">-</div>
          </div>
          <div class="status-item">
            <label>Sunset</label>
            <div class="value" id="sun-sunset">-</div>
          </div>
          <div class="status-item">
            <label>Solar Noon</label>
            <div class="value" id="sun-noon">-</div>
          </div>
          <div class="status-item">
            <label>Day Length</label>
            <div class="value" id="sun-length">-</div>
          </div>
        </div>
        <div class="btn-group">
          <button class="btn btn-secondary" onclick="refreshSunTimes()">üîÑ Refresh Sun Times</button>
        </div>
      </div>
      
      <!-- GIF Gallery Card -->
      <div class="card full-width">
        <h2>üé¨ GIF Gallery</h2>
        <div class="gif-gallery" id="gif-gallery">
          <div class="empty-state">No GIFs generated yet</div>
        </div>
      </div>
    </div>
    </div><!-- end tab-dashboard -->

    <div id="tab-captures" class="tab-content">
      <div class="card">
        <h2>üì∏ Capture Gallery</h2>
        
        <div class="captures-toolbar">
          <input type="date" id="capture-date-picker" onchange="onDatePicked(this.value)">
          <button class="btn btn-secondary" onclick="clearDateFilter()">Show All Dates</button>
          <span id="captures-count" style="color: #888; font-size: 0.9rem;"></span>
        </div>

        <div class="date-chips" id="date-chips"></div>

        <div id="video-container"></div>

        <div id="captures-grid" class="captures-gallery">
          <div class="empty-state">Select a date to view captures</div>
        </div>
      </div>
    </div><!-- end tab-captures -->

  </div>
  
  <!-- Modal for viewing GIFs/images -->
  <div class="modal" id="gif-modal" onclick="closeModal()">
    <span class="modal-close">&times;</span>
    <div class="modal-content">
      <img id="modal-image" src="" alt="Preview">
    </div>
  </div>
  
  <script>
    // State
    let currentConfig = null;
    let statusInterval = null;
    let countdownInterval = null;
    let nextEventTime = null;
    let captureDates = [];
    let selectedDate = null;
    let videoGenerating = false;
    
    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      loadConfig();
      loadStatus();
      loadGifs();
      loadSunTimes();
      
      // Refresh status every 5 seconds
      statusInterval = setInterval(loadStatus, 5000);
      
      // Update countdown every second
      countdownInterval = setInterval(updateCountdown, 1000);
    });
    
    // Show alert
    function showAlert(message, type = 'success') {
      const container = document.getElementById('alert-container');
      const alert = document.createElement('div');
      alert.className = `alert alert-${type}`;
      alert.textContent = message;
      container.appendChild(alert);
      
      setTimeout(() => alert.remove(), 5000);
    }
    
    // Load configuration
    async function loadConfig() {
      try {
        const response = await fetch('/api/config');
        currentConfig = await response.json();
        
        document.getElementById('config-camera-url').value = currentConfig.camera.url;
        document.getElementById('config-event-type').value = currentConfig.capture.eventType;
        document.getElementById('config-interval').value = currentConfig.capture.intervalSeconds;
        document.getElementById('config-offset').value = currentConfig.capture.offsetMinutes;
        document.getElementById('config-frame-delay').value = currentConfig.gif.frameDelayMs;
        document.getElementById('config-gif-width').value = currentConfig.gif.resizeWidth;
        document.getElementById('config-enabled').checked = currentConfig.capture.enabled;
      } catch (error) {
        showAlert('Failed to load configuration', 'error');
      }
    }
    
    // Save configuration
    async function saveConfig(event) {
      event.preventDefault();
      
      const config = {
        camera: {
          url: document.getElementById('config-camera-url').value
        },
        capture: {
          eventType: document.getElementById('config-event-type').value,
          intervalSeconds: parseInt(document.getElementById('config-interval').value),
          offsetMinutes: parseInt(document.getElementById('config-offset').value),
          enabled: document.getElementById('config-enabled').checked
        },
        gif: {
          frameDelayMs: parseInt(document.getElementById('config-frame-delay').value),
          resizeWidth: parseInt(document.getElementById('config-gif-width').value)
        }
      };
      
      try {
        const response = await fetch('/api/config', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(config)
        });
        
        if (response.ok) {
          showAlert('Configuration saved successfully');
          loadStatus();
        } else {
          throw new Error('Failed to save');
        }
      } catch (error) {
        showAlert('Failed to save configuration', 'error');
      }
    }
    
    // Load status
    async function loadStatus() {
      try {
        const response = await fetch('/api/status');
        const data = await response.json();
        
        const stateEl = document.getElementById('status-state');
        stateEl.textContent = data.state.status.charAt(0).toUpperCase() + data.state.status.slice(1);
        stateEl.className = `value ${data.state.status}`;
        
        document.getElementById('status-captures').textContent = data.state.captureCount || 0;
        document.getElementById('status-event').textContent = data.settings.eventType.charAt(0).toUpperCase() + data.settings.eventType.slice(1);
        
        if (data.state.nextCaptureWindow) {
          const startTime = new Date(data.state.nextCaptureWindow.start);
          const eventTime = new Date(data.state.nextCaptureWindow.eventTime);
          nextEventTime = startTime;
          
          // Display start time (when capturing will begin)
          document.getElementById('status-next').textContent = startTime.toLocaleTimeString('en-US', { 
            hour: '2-digit', 
            minute: '2-digit',
            second: '2-digit'
          });
          
          // Display date and event time
          const dateStr = startTime.toLocaleDateString('en-US', { 
            month: 'short', 
            day: 'numeric'
          });
          const eventTypeStr = data.settings.eventType.charAt(0).toUpperCase() + data.settings.eventType.slice(1);
          const eventTimeStr = eventTime.toLocaleTimeString('en-US', { 
            hour: '2-digit', 
            minute: '2-digit'
          });
          
          document.getElementById('status-next-date').textContent = `${dateStr} (${eventTypeStr} ${eventTimeStr})`;
        } else {
          nextEventTime = null;
          document.getElementById('status-next').textContent = '-';
          document.getElementById('status-next-date').textContent = '';
        }
        
        // Update button states
        const isCapturing = data.state.status === 'capturing';
        document.getElementById('btn-start').disabled = isCapturing;
        document.getElementById('btn-stop').disabled = !isCapturing;
        
      } catch (error) {
        console.error('Failed to load status:', error);
      }
    }
    
    // Update countdown
    function updateCountdown() {
      const el = document.getElementById('countdown');
      
      if (!nextEventTime) {
        el.textContent = '--:--:--';
        return;
      }
      
      const now = new Date();
      const diff = nextEventTime - now;
      
      if (diff <= 0) {
        el.textContent = 'Starting...';
        return;
      }
      
      const hours = Math.floor(diff / (1000 * 60 * 60));
      const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
      const seconds = Math.floor((diff % (1000 * 60)) / 1000);
      
      el.textContent = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }
    
    // Load sun times
    async function loadSunTimes() {
      try {
        const response = await fetch('/api/sun-times');
        const data = await response.json();
        
        document.getElementById('sun-sunrise').textContent = new Date(data.sunrise).toLocaleTimeString();
        document.getElementById('sun-sunset').textContent = new Date(data.sunset).toLocaleTimeString();
        document.getElementById('sun-noon').textContent = new Date(data.solarNoon).toLocaleTimeString();
        
        // Format day length (seconds to hours:minutes)
        const hours = Math.floor(data.dayLength / 3600);
        const minutes = Math.floor((data.dayLength % 3600) / 60);
        document.getElementById('sun-length').textContent = `${hours}h ${minutes}m`;
        
      } catch (error) {
        console.error('Failed to load sun times:', error);
      }
    }
    
    // Refresh sun times
    async function refreshSunTimes() {
      try {
        await fetch('/api/sun-times/refresh', { method: 'POST' });
        await loadSunTimes();
        showAlert('Sun times refreshed');
      } catch (error) {
        showAlert('Failed to refresh sun times', 'error');
      }
    }
    
    // Test camera
    async function testCamera() {
      const placeholder = document.getElementById('preview-placeholder');
      const image = document.getElementById('preview-image');
      
      placeholder.textContent = 'Loading...';
      
      try {
        const response = await fetch('/api/camera/test');
        const data = await response.json();
        
        if (data.success) {
          // Load actual preview
          image.src = '/api/preview?' + Date.now();
          image.style.display = 'block';
          placeholder.style.display = 'none';
          showAlert(`Camera OK - ${Math.round(data.size / 1024)} KB`);
        } else {
          throw new Error(data.error);
        }
      } catch (error) {
        placeholder.textContent = 'Failed to connect to camera: ' + error.message;
        placeholder.style.display = 'block';
        image.style.display = 'none';
        showAlert('Camera connection failed', 'error');
      }
    }
    
    // Start capture
    async function startCapture() {
      const intervalSeconds = parseInt(document.getElementById('manual-interval').value) || 15;
      const maxCaptures = parseInt(document.getElementById('manual-max-captures').value) || 0;
      
      try {
        const response = await fetch('/api/capture/start', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            intervalSeconds,
            maxCaptures: maxCaptures > 0 ? maxCaptures : null
          })
        });
        const data = await response.json();
        
        if (data.success) {
          showAlert(data.message);
          loadStatus();
          
          // If capture completed immediately (fixed number reached)
          if (data.message.includes('completed')) {
            loadGifs();
          }
        } else {
          showAlert(data.message, 'error');
        }
      } catch (error) {
        showAlert('Failed to start capture', 'error');
      }
    }
    
    // Stop capture
    async function stopCapture() {
      try {
        const response = await fetch('/api/capture/stop', { method: 'POST' });
        const data = await response.json();
        
        if (data.success) {
          showAlert('Capture stopped - GIF generated');
          loadStatus();
          loadGifs();
        } else {
          showAlert(data.message, 'error');
        }
      } catch (error) {
        showAlert('Failed to stop capture', 'error');
      }
    }
    
    // Load GIFs
    async function loadGifs() {
      try {
        const response = await fetch('/api/gifs');
        const gifs = await response.json();
        
        const gallery = document.getElementById('gif-gallery');
        
        if (gifs.length === 0) {
          gallery.innerHTML = '<div class="empty-state">No GIFs generated yet</div>';
          return;
        }
        
        gallery.innerHTML = gifs.map(gif => `
          <div class="gif-item" onclick="openModal('${gif.path}')">
            <img src="${gif.path}" alt="${gif.filename}" loading="lazy">
            <div class="info">
              <div class="date">${gif.date} - ${gif.eventType}</div>
              <div class="meta">${gif.sizeFormatted}</div>
            </div>
          </div>
        `).join('');
        
      } catch (error) {
        console.error('Failed to load GIFs:', error);
      }
    }
    
    // Modal functions
    function openModal(src) {
      const modal = document.getElementById('gif-modal');
      const image = document.getElementById('modal-image');
      image.src = src;
      modal.classList.add('active');
    }
    
    function closeModal() {
      const modal = document.getElementById('gif-modal');
      modal.classList.remove('active');
    }
    
    // Close modal on escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') closeModal();
    });

    // ============ Tab Navigation ============

    function switchTab(tabName) {
      // Update tab buttons
      document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));

      const btn = document.querySelector(`.tab-btn[onclick="switchTab('${tabName}')"]`);
      const tab = document.getElementById(`tab-${tabName}`);
      if (btn) btn.classList.add('active');
      if (tab) tab.classList.add('active');

      // Load captures data when switching to captures tab
      if (tabName === 'captures' && captureDates.length === 0) {
        loadCaptureDates();
      }
    }

    // ============ Captures Gallery ============

    async function loadCaptureDates() {
      try {
        const response = await fetch('/api/captures');
        captureDates = await response.json();
        renderDateChips();
      } catch (error) {
        showAlert('Failed to load capture dates', 'error');
      }
    }

    function renderDateChips() {
      const container = document.getElementById('date-chips');
      if (captureDates.length === 0) {
        container.innerHTML = '<span style="color: #888;">No captures available</span>';
        return;
      }

      container.innerHTML = captureDates.map(date => `
        <span class="date-chip ${selectedDate === date ? 'active' : ''}" 
              onclick="onDatePicked('${date}')">${date}</span>
      `).join('');
    }

    function onDatePicked(date) {
      if (!date) return;
      selectedDate = date;

      // Sync date picker input
      document.getElementById('capture-date-picker').value = date;
      renderDateChips();
      loadCapturesForDate(date);
    }

    function clearDateFilter() {
      selectedDate = null;
      document.getElementById('capture-date-picker').value = '';
      document.getElementById('video-container').innerHTML = '';
      document.getElementById('captures-count').textContent = '';
      renderDateChips();
      
      // Show all dates overview
      renderAllDatesOverview();
    }

    async function renderAllDatesOverview() {
      const grid = document.getElementById('captures-grid');
      if (captureDates.length === 0) {
        grid.innerHTML = '<div class="empty-state">No captures available</div>';
        return;
      }

      grid.innerHTML = '<div class="empty-state">Loading all captures...</div>';

      // Show first image from each date as a date card
      const cards = [];
      for (const date of captureDates) {
        try {
          const response = await fetch(`/api/captures/${date}`);
          const captures = await response.json();
          if (captures.length > 0) {
            cards.push({ date, count: captures.length, firstImage: captures[0] });
          }
        } catch (e) { /* skip */ }
      }

      if (cards.length === 0) {
        grid.innerHTML = '<div class="empty-state">No captures available</div>';
        return;
      }

      grid.innerHTML = cards.map(card => `
        <div class="capture-item" onclick="onDatePicked('${card.date}')">
          <img src="${card.firstImage.path}" alt="${card.date}" loading="lazy">
          <div class="info">
            <div class="time">${card.date}</div>
            <div style="color: #888; font-size: 0.8rem;">${card.count} captures</div>
          </div>
        </div>
      `).join('');
    }

    async function loadCapturesForDate(date) {
      const grid = document.getElementById('captures-grid');
      const videoContainer = document.getElementById('video-container');
      const countEl = document.getElementById('captures-count');

      grid.innerHTML = '<div class="empty-state">Loading...</div>';
      videoContainer.innerHTML = '';

      try {
        // Load captures and video info in parallel
        const [capturesRes, videoRes] = await Promise.all([
          fetch(`/api/captures/${date}`),
          fetch(`/api/video/${date}`)
        ]);

        const captures = await capturesRes.json();
        const videoData = await videoRes.json();

        countEl.textContent = `${captures.length} captures`;

        // Render video section
        renderVideoSection(date, videoData, videoContainer);

        // Render capture thumbnails
        if (captures.length === 0) {
          grid.innerHTML = '<div class="empty-state">No captures for this date</div>';
          return;
        }

        grid.innerHTML = captures.map(cap => `
          <div class="capture-item" onclick="openModal('${cap.path}')">
            <img src="${cap.path}" alt="${cap.filename}" loading="lazy">
            <div class="info">
              <div class="time">${cap.time || cap.filename.replace('.jpg', '').replace(/-/g, ':')}</div>
            </div>
          </div>
        `).join('');

      } catch (error) {
        grid.innerHTML = '<div class="empty-state">Failed to load captures</div>';
        showAlert('Failed to load captures', 'error');
      }
    }

    function renderVideoSection(date, videoData, container) {
      let videoHtml = '';

      if (videoData.exists && videoData.video) {
        const v = videoData.video;
        videoHtml = `
          <div class="video-section">
            <h3>üé¨ Video - ${date}</h3>
            <video controls preload="metadata">
              <source src="${v.path}" type="video/mp4">
              Your browser does not support the video element.
            </video>
            <div class="video-actions">
              <a href="${v.path}" download class="btn btn-secondary" style="text-decoration: none; padding: 8px 16px; font-size: 0.9rem;">‚¨á Download</a>
              <button class="btn btn-primary" style="padding: 8px 16px; font-size: 0.9rem;" onclick="generateVideoForDate('${date}')" ${videoGenerating ? 'disabled' : ''}>
                üîÑ Regenerate
              </button>
              <button class="btn btn-danger" style="padding: 8px 16px; font-size: 0.9rem;" onclick="deleteVideoForDate('${v.filename}', '${date}')">
                üóë Delete
              </button>
              <span class="video-meta">${v.sizeFormatted}</span>
            </div>
          </div>`;
      } else {
        videoHtml = `
          <div class="video-section">
            <h3>üé¨ Video - ${date}</h3>
            <div style="color: #888; margin-bottom: 12px;">No video generated yet for this date.</div>
            <button class="btn btn-primary" id="btn-gen-video" onclick="generateVideoForDate('${date}')" ${videoGenerating ? 'disabled' : ''}>
              ${videoGenerating ? '<span class="spinner"></span>Generating...' : 'üé¨ Generate Video'}
            </button>
          </div>`;
      }

      container.innerHTML = videoHtml;
    }

    async function generateVideoForDate(date) {
      if (videoGenerating) return;
      videoGenerating = true;

      const videoContainer = document.getElementById('video-container');
      videoContainer.innerHTML = `
        <div class="video-section">
          <h3>üé¨ Video - ${date}</h3>
          <div style="color: #888; margin-bottom: 12px;">
            <span class="spinner"></span> Generating video... This may take a moment.
          </div>
          <button class="btn btn-primary" disabled>
            <span class="spinner"></span>Generating...
          </button>
        </div>`;

      try {
        const response = await fetch(`/api/video/generate/${date}`, { method: 'POST' });
        const data = await response.json();

        if (data.success) {
          showAlert('Video generated successfully!');
          // Reload video section
          const videoRes = await fetch(`/api/video/${date}`);
          const videoData = await videoRes.json();
          renderVideoSection(date, videoData, videoContainer);
        } else {
          throw new Error(data.error || 'Generation failed');
        }
      } catch (error) {
        showAlert('Failed to generate video: ' + error.message, 'error');
        // Re-render without video
        renderVideoSection(date, { exists: false }, videoContainer);
      } finally {
        videoGenerating = false;
      }
    }

    async function deleteVideoForDate(filename, date) {
      if (!confirm(`Delete video for ${date}?`)) return;

      try {
        const response = await fetch(`/api/video/${filename}`, { method: 'DELETE' });
        const data = await response.json();

        if (data.success) {
          showAlert('Video deleted');
          const videoContainer = document.getElementById('video-container');
          renderVideoSection(date, { exists: false }, videoContainer);
        } else {
          showAlert('Failed to delete video', 'error');
        }
      } catch (error) {
        showAlert('Failed to delete video', 'error');
      }
    }
  </script>
</body>
</html>
